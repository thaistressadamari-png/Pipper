rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Função auxiliar para verificar se é admin
    function isAdmin() {
      return request.auth != null;
    }

    // --- Produtos e Loja (Leitura Pública, Escrita Admin) ---
    match /products/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /store/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /metadata/categories {
      allow read: if true;
      allow write: if isAdmin();
    }

    // --- Pedidos ---
    match /orders/{orderId} {
      // Qualquer um pode criar pedidos (clientes não logados)
      // A estrutura (variações, observações) é aceita automaticamente
      allow create: if true;
      
      // Leitura pública necessária para o rastreamento (tracking) funcionar sem login
      allow read: if true;
      
      // Atualização e exclusão apenas para admins (ex: mudar status)
      allow update, delete: if isAdmin();
    }

    // --- Contadores (CRÍTICO) ---
    // Necessário 'write: if true' para que a transação de gerar ID do pedido funcione
    match /metadata/counters {
      allow read: if true;
      allow write: if true; 
    }

    // --- Clientes ---
    // Necessário para salvar o histórico do cliente ao finalizar pedido
    match /clients/{clientId} {
      allow read: if isAdmin();
      allow write: if true;
    }

    // --- Estatísticas ---
    match /dailyVisits/{date} {
      allow read: if isAdmin();
      allow write: if true;
    }
    
    match /metadata/siteStats {
      allow read: if isAdmin();
      allow write: if true;
    }
  }
}